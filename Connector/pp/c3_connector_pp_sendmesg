#!/data/Software/mydan/perl/bin/perl -I/data/Software/mydan/Connector/lib -I/data/Software/mydan/Connector/private/lib
use strict;
use warnings;
use uuid;
use POSIX;

binmode STDIN, ':utf8';
binmode STDOUT, ':utf8';
binmode STDERR, ':utf8';

$|++;

use MYDB;
use FindBin qw( $RealBin );
use MYDan::Util::OptConf;
use YAML::XS;
use Encode;
use MIME::Base64;
use LWP::UserAgent;
use JSON;
use Configini;

=head1 SYNOPSIS

 $0 user1 user2 ... user3

=cut

my $db = MYDB->new( "$RealBin/../conf/conn" );
my $option = MYDan::Util::OptConf->load();
my %o = $option->get()->dump();
$option->assert() unless @ARGV;

local $/ = undef;
my $mesg = Encode::encode('utf8', <STDIN> );
local $/ = "\n";

my ( $usermesg, %env );
$usermesg = Configini::get( 'usermesg' );
%env = Configini::env( 'usermesgenv' );

my $ua = LWP::UserAgent->new;
$ua->default_header( %env ) if %env;

sub sendmesg
{
    my ( $user, $mesg ) = @_;

    my $x = $db->query( sprintf "select `phone` from openc3_connector_useraddr where user='$user'" );
    $user = $x->[0][0] if @$x;

    if( $usermesg =~ /api.connector.open-c3.org/ )
    {
        $mesg =~ s/'/"/g;
        eval{ $db->execute( "insert into openc3_connector_usermesg (`user`,`mesg`) values('$user','$mesg')" )};
        die "send mesg info to db fail:$@"  if $@;
        return;
    }

    my $cont = JSON::encode_json( +{ user => $user, mesg => $mesg } );
    my $res = $ua->post( $usermesg, Content => $cont, 'Content-Type' => 'application/json');

    die "call mesg api fail:$res->decoded_content" unless $res->is_success;

    my $v = eval{JSON::decode_json $res->decoded_content};
    die "call mesg api: $v->{info}" unless $v->{stat};
}

map{ sendmesg( $_, $mesg ) }@ARGV;
